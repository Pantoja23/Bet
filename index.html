<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root { --neon: #00f2ff; --gold: #ffd700; --bg-dark: rgba(0, 0, 0, 0.9); --card-bg: rgba(20, 20, 25, 0.98); }
    body { 
      font-family: 'Arial Black', sans-serif; background: #000;
      background-image: linear-gradient(var(--bg-dark), var(--bg-dark)), url('https://images.pexels.com/photos/399187/pexels-photo-399187.jpeg?auto=compress&cs=tinysrgb&w=800');
      background-attachment: fixed; background-size: cover; color: #fff; margin: 0; -webkit-tap-highlight-color: transparent;
    }

    /* EFECTOS KINGELAS - LOGO Y RESPLANDOR */
    .logo-container { text-align: center; margin-bottom: 5px; }
    .logo-text {
      font-size: 3.5rem;
      color: #fff;
      text-transform: uppercase;
      margin: 0;
      letter-spacing: -2px;
      text-shadow: 0 0 10px var(--neon), 0 0 20px var(--neon), 0 0 40px var(--neon);
      animation: pulsate 1.5s infinite alternate;
    }
    .crown-icon { font-size: 2.5rem; color: var(--gold); filter: drop-shadow(0 0 10px var(--gold)); }

    @keyframes pulsate {
      100% { text-shadow: 0 0 4px var(--neon), 0 0 11px var(--neon), 0 0 19px var(--neon), 0 0 40px var(--neon), 0 0 80px var(--neon); transform: scale(1.05); }
      0% { text-shadow: 0 0 2px var(--neon), 0 0 4px var(--neon), 0 0 6px var(--neon), 0 0 10px var(--neon); transform: scale(1); }
    }

    .slogan {
      font-size: 10px;
      color: var(--gold);
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
      margin-bottom: 25px;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
      font-style: italic;
    }

    /* Overlay de carga "Scanner" */
    #loading_overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; }
    .scanner { width: 250px; height: 3px; background: var(--neon); box-shadow: 0 0 25px var(--neon); animation: scan 1.2s infinite ease-in-out; }
    @keyframes scan { 0% { transform: translateY(-60px); opacity: 0.3; } 50% { opacity: 1; } 100% { transform: translateY(60px); opacity: 0.3; } }
    
    #login_screen { background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.9)), url('https://images.pexels.com/photos/46798/the-ball-stadion-football-the-pitch-46798.jpeg?auto=compress&cs=tinysrgb&w=800'); background-size: cover; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; }
    
    /* HEADER ULTRA COMPACTO */
    .header { 
      background: rgba(0, 0, 0, 0.95); 
      padding: 8px 15px; 
      border-bottom: 2px solid var(--neon); 
      position: sticky; top: 0; z-index: 100; 
      display: flex; justify-content: space-between; align-items: center;
    }
    .user-info { font-size: 10px; color: var(--neon); text-transform: uppercase; font-weight: bold; }
    #txt_saldo { font-size: 1.4em; color: #fff; font-weight: 900; }

    /* PANEL MASTER */
    #admin_box { background: var(--card-bg); border: 2px solid var(--gold); margin: 10px 15px; padding: 10px; border-radius: 12px; display: none; }
    .tab-btns { display: flex; margin-bottom: 8px; border-radius: 5px; overflow: hidden; }
    .tab-btn { background: #222; color: #aaa; border: none; padding: 6px; flex: 1; font-size: 9px; font-weight: bold; }
    .tab-btn.active { background: var(--gold); color: #000; }
    
    select, .input-master, .input-login { width: 100%; padding: 8px; margin-bottom: 6px; border-radius: 6px; background: #000; color: var(--neon); border: 1px solid var(--neon); font-weight: bold; box-sizing: border-box; font-size: 12px; }
    
    /* CARDS DE JUEGOS */
    .game-card { background: var(--card-bg); padding: 12px; margin: 8px 15px; border-radius: 15px; border: 1px solid rgba(0, 242, 255, 0.3); }
    .teams { display: flex; justify-content: space-between; align-items: center; font-size: 1em; font-weight: 900; }
    .vs { color: var(--neon); font-size: 0.7em; font-style: italic; }

    .btn-neon { background: var(--neon); color: #000; border: none; padding: 12px; width: 100%; font-weight: 900; border-radius: 8px; text-transform: uppercase; font-size: 0.9em; box-shadow: 0 0 15px var(--neon); }
    .opt { flex: 1; padding: 10px; background: rgba(0,0,0,0.6); border: 1px solid #333; color: #fff; border-radius: 8px; text-align: center; font-weight: bold; font-size: 13px; }
    .opt.selected { background: var(--neon); color: #000; box-shadow: 0 0 10px var(--neon); border-color: #fff; }
    
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.98); padding: 10px; border-top: 2px solid var(--neon); box-sizing: border-box; z-index: 200; }
  </style>
</head>
<body>

  <div id="loading_overlay"><div class="scanner"></div><p style="color:var(--neon); margin-top:20px; letter-spacing:3px; font-size:9px;">PROCESANDO...</p></div>

  <div id="login_screen">
    <div class="logo-container">
      <div class="crown-icon">ðŸ‘‘</div>
      <h1 class="logo-text">KINGELAS</h1>
    </div>
    <div class="slogan">"TU REINO. TUS REGLAS.<br>DONDE LOS REYES FORJAN SU LEYENDA."</div>
    
    <input type="text" id="id_user" class="input-login" style="width:75%" placeholder="ID REY">
    <input type="password" id="pass_user" class="input-login" style="width:75%" placeholder="PASSWORD">
    <button class="btn-neon" onclick="entrarConEfecto()" style="width:80%; margin-top:10px;">RECLAMAR TRONO</button>
    
    <audio id="snd_sword" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
  </div>

  <div id="main_app" style="display:none;">
    <div class="header">
      <div class="user-info" id="txt_nombre">PLAYER</div>
      <div id="txt_saldo">$0.00</div>
    </div>

    <div id="admin_box">
      <div class="tab-btns">
        <button class="tab-btn active" id="btn_tab_1" onclick="switchTab(1)">CRÃ‰DITOS</button>
        <button class="tab-btn" id="btn_tab_2" onclick="switchTab(2)">NUEVO PLAYER</button>
      </div>

      <div id="tab_creditos">
        <select id="select_usuarios"><option value="">CARGANDO JUGADORES...</option></select>
        <div style="display:flex; gap:8px;">
          <input type="number" id="amount_credit" class="input-master" style="flex:1" placeholder="MONTO $$">
          <button onclick="addCredit()" style="background:var(--gold); border:none; border-radius:6px; font-weight:900; padding:0 12px; height:32px; font-size:10px;">CARGAR</button>
        </div>
      </div>

      <div id="tab_registro" style="display:none;">
        <input type="text" id="reg_id" class="input-master" placeholder="ID NUEVO">
        <input type="text" id="reg_nombre" class="input-master" placeholder="NOMBRE COMPLETO">
        <input type="text" id="reg_pass" class="input-master" placeholder="PASSWORD">
        <button onclick="crearPlayer()" style="background:var(--neon); color:#000; border:none; width:100%; border-radius:6px; font-weight:900; padding:8px; font-size:10px;">REGISTRAR EN TABLA</button>
      </div>
      <button onclick="verRanking()" style="background:transparent; color:var(--gold); border:1px solid var(--gold); padding:4px; width:100%; border-radius:6px; font-size:8px; margin-top:8px;">RANKING JORNADA</button>
    </div>

    <h2 id="tit_jornada" style="text-align:center; color:var(--neon); letter-spacing:4px; margin:12px 0; text-transform:uppercase; font-size:0.9em; opacity:0.8;"></h2>

    <div id="contenedor_juegos" style="padding-bottom: 80px;"></div>
    
    <div class="footer">
      <button class="btn-neon" onclick="enviar()">CONFIRMAR QUINIELA ($10)</button>
    </div>
  </div>

  <audio id="bg_music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3"></audio>

<script>
  const URL_EXEC = "https://script.google.com/macros/s/AKfycbxWTtwAF2Dg32JguwUywxVb1ztO59GOI3gtiRGjxvuIWOBG0MYKvpacP5Lcl4mk86Sd/exec"; 
  let USER_DATA = {}, JUEGOS = [], PICKS = {};

  function entrarConEfecto() {
    document.getElementById('snd_sword').play();
    entrar();
  }

  function entrar() {
    const id = document.getElementById('id_user').value;
    const pass = document.getElementById('pass_user').value;
    if(!id || !pass) return alert("Completa los datos");
    
    mostrarCarga(true);
    fetchJSONP(`${URL_EXEC}?action=login&id=${id}&pass=${pass}`, function(res) {
      mostrarCarga(false);
      if(res.success) {
        USER_DATA = res.user;
        
        // Iniciar mÃºsica Ã©pica
        const music = document.getElementById('bg_music');
        music.volume = 0.2;
        music.play().catch(e => console.log("Audio waiting for interaction"));

        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('main_app').style.display = 'block';
        document.getElementById('txt_nombre').innerText = "ðŸ‘‘ " + USER_DATA.nombre;
        document.getElementById('txt_saldo').innerText = "$" + USER_DATA.saldo;
        
        if(USER_DATA.nivel === "Master") {
          document.getElementById('admin_box').style.display = 'block';
          cargarListaUsuarios(); 
        }
        cargarJuegos();
      } else { alert("ACCESO DENEGADO AL REINO"); }
    });
  }

  function cargarJuegos() {
    fetchJSONP(`${URL_EXEC}?action=getGames`, function(res) {
      JUEGOS = res;
      if(JUEGOS.length > 0) {
        document.getElementById('tit_jornada').innerText = "PARTIDOS JORNADA " + JUEGOS[0].jornada;
      }
      const cont = document.getElementById('contenedor_juegos');
      cont.innerHTML = "";
      JUEGOS.forEach((j, i) => {
        const d = document.createElement('div');
        d.className = 'game-card';
        d.innerHTML = `
          <div style="font-size:9px; color:#888; margin-bottom:8px; text-align:center;">${j.fecha} - ${j.estadio}</div>
          <div class="teams">
            <span>${j.local}</span>
            <span class="vs">VS</span>
            <span>${j.visita}</span>
          </div>
          <div style="display:flex; gap:8px; margin-top:12px;">
            <div class="opt" onclick="sel(${i},'L',this)">L</div>
            <div class="opt" onclick="sel(${i},'E',this)">E</div>
            <div class="opt" onclick="sel(${i},'V',this)">V</div>
          </div>`;
        cont.appendChild(d);
      });
    });
  }

  function sel(idx, p, btn) {
    if (window.navigator.vibrate) window.navigator.vibrate(20);
    btn.parentElement.querySelectorAll('.opt').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    PICKS[idx] = p;
  }

  function crearPlayer() {
    const nid = document.getElementById('reg_id').value;
    const nnom = document.getElementById('reg_nombre').value;
    const npass = document.getElementById('reg_pass').value;
    if(!nid || !nnom || !npass) return alert("Faltan datos");
    
    mostrarCarga(true);
    fetchJSONP(`${URL_EXEC}?action=crearUsuario&nuevoId=${nid}&nuevoNombre=${nnom}&nuevoPass=${npass}`, function(res) {
      mostrarCarga(false);
      alert(res.msg);
      if(res.success) {
        document.getElementById('reg_id').value=""; 
        document.getElementById('reg_nombre').value=""; 
        document.getElementById('reg_pass').value="";
        cargarListaUsuarios(); 
      }
    });
  }

  function cargarListaUsuarios() {
    fetchJSONP(`${URL_EXEC}?action=getUsers`, function(usuarios) {
      const select = document.getElementById('select_usuarios');
      select.innerHTML = '<option value="">SELECCIONAR JUGADOR...</option>';
      usuarios.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.innerText = u.nombre + " (" + u.id + ")";
        select.appendChild(opt);
      });
    });
  }

  function addCredit() {
    const target = document.getElementById('select_usuarios').value;
    const amount = document.getElementById('amount_credit').value;
    if(!target || !amount) return alert("Elige usuario y monto");
    mostrarCarga(true);
    fetchJSONP(`${URL_EXEC}?action=addCredit&idTarget=${target}&amount=${amount}`, function(res) {
       mostrarCarga(false);
       alert(res.msg);
       document.getElementById('amount_credit').value = "";
       if(target === USER_DATA.id) location.reload();
    });
  }

  function enviar() {
    if(Object.keys(PICKS).length < JUEGOS.length) return alert("Faltan partidos por seleccionar");
    if(!confirm("Â¿Confirmar envÃ­o de quiniela por $10 USD?")) return;
    
    const ventanaWhatsApp = window.open("", "_blank");
    ventanaWhatsApp.document.write("<html><body style='background:#000;color:#00f2ff;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h2>KINGELAS</h2><p>Generando Ticket Real...</p></body></html>");

    mostrarCarga(true);
    const pStr = Object.values(PICKS).join(',');
    
    fetchJSONP(`${URL_EXEC}?action=registrarQuiniela&idUser=${USER_DATA.id}&picks=${pStr}&jornada=${JUEGOS[0].jornada}`, function(r) {
      if(r.msg.includes("âœ…")) {
        const transaccion = "KING-" + Math.floor(Math.random() * 900000 + 100000);
        let mensaje = "ðŸ‘‘ *TICKET: KINGELAS*%0A";
        mensaje += "ðŸ†” *Ticket:* " + transaccion + "%0A";
        mensaje += "ðŸ‘¤ *Rey:* " + USER_DATA.nombre + "%0A";
        mensaje += "ðŸ† *Jornada:* " + JUEGOS[0].jornada + "%0A";
        mensaje += "--------------------------%0A";

        JUEGOS.forEach((j, i) => {
          let pick = PICKS[i];
          let equipo = (pick === 'L') ? j.local : (pick === 'V' ? j.visita : "Empate");
          let icono = (j.local + j.visita).toUpperCase().match(/NBA|LAKERS|PHOENIX|BULLS|WARRIORS|NETS|KNICKS|CELTICS/) ? "ðŸ€" : "âš½";
          mensaje += (i + 1) + ". " + icono + " " + equipo + "%0A";
        });

        mensaje += "--------------------------%0A";
        mensaje += "ðŸ’° *Costo:* $10 USD%0A";
        mensaje += "âœ… *AUTORIZADO POR EL REINO*";

        const urlWhatsApp = "https://api.whatsapp.com/send?phone=19152607928&text=" + mensaje;
        ventanaWhatsApp.location.href = urlWhatsApp;

        alert("Â¡Conquista Registrada! Ticket: " + transaccion);
        location.reload(); 
      } else {
        ventanaWhatsApp.close();
        mostrarCarga(false);
        alert(r.msg);
      }
    });
  }

  function switchTab(n) {
    document.getElementById('tab_creditos').style.display = (n === 1) ? 'block' : 'none';
    document.getElementById('tab_registro').style.display = (n === 2) ? 'block' : 'none';
    document.getElementById('btn_tab_1').className = (n === 1) ? 'tab-btn active' : 'tab-btn';
    document.getElementById('btn_tab_2').className = (n === 2) ? 'tab-btn active' : 'tab-btn';
  }

  function verRanking() {
    fetchJSONP(`${URL_EXEC}?action=verGanadores&jornada=${JUEGOS[0].jornada}`, function(res) {
      let r = "ðŸ† RANKING JORNADA " + JUEGOS[0].jornada + "\n\n";
      res.forEach((u, i) => r += `${i+1}Âº ${u.nombre} - ${u.puntos} pts\n`);
      alert(r);
    });
  }

  function mostrarCarga(s) { document.getElementById('loading_overlay').style.display = s ? 'flex' : 'none'; }

  function fetchJSONP(url, callback) {
    const callbackName = 'jsonp_' + Math.round(100000 * Math.random());
    window[callbackName] = function(data) {
      delete window[callbackName];
      document.body.removeChild(script);
      callback(data);
    };
    const script = document.createElement('script');
    script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
    document.body.appendChild(script);
  }
</script>
</body>
</html>
